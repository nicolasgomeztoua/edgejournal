# EdgeJournal - Cursor Rules

## Project Overview
EdgeJournal is a trading journal application built with Next.js 15, tRPC, Drizzle ORM, and PostgreSQL.

## Design System: "The Terminal"
- **Background**: Obsidian black (#050505)
- **Primary**: Electric Chartreuse (#d4ff00)
- **Accent**: Ice Blue (#00d4ff)
- **Profit**: #00ff88
- **Loss**: #ff3b3b
- **Breakeven**: #fbbf24
- **Fonts**: Syne for display/body, JetBrains Mono for data/code
- **Border radius**: Minimal (4px)
- See `DESIGN_SYSTEM.md` for full details

## Tech Stack
- **Framework**: Next.js 15 (App Router)
- **API**: tRPC v11
- **Database**: PostgreSQL with Drizzle ORM
- **Auth**: Clerk
- **Styling**: Tailwind CSS v4
- **UI Components**: shadcn/ui
- **Package Manager**: Bun

## Code Patterns

### Optimistic Updates with tRPC
Always use optimistic updates for better UX. Use the hooks from `@/hooks/use-debounced-mutation`:

```tsx
import { useOptimisticState, useDebouncedMutation } from "@/hooks/use-debounced-mutation";

// For simple optimistic state (arrays/objects)
const [optimisticUpdates, setOptimisticUpdates] = useState<Map<number, Partial<Item>>>(new Map());

const mutation = api.resource.update.useMutation({
  onMutate: (input) => {
    // Apply optimistic update immediately
    setOptimisticUpdates((prev) => {
      const next = new Map(prev);
      next.set(input.id, { field: input.value });
      return next;
    });
  },
  onError: (error, variables) => {
    // Rollback on error
    setOptimisticUpdates((prev) => {
      const next = new Map(prev);
      next.delete(variables.id);
      return next;
    });
    toast.error("Failed to update");
  },
  onSettled: async () => {
    // Clear optimistic state AFTER invalidation completes
    await utils.resource.getAll.invalidate();
    setOptimisticUpdates(new Map());
  },
});

// Merge optimistic updates with server data
const displayData = data?.map((item) => {
  const updates = optimisticUpdates.get(item.id);
  return updates ? { ...item, ...updates } : item;
});
```

### Debounced Mutations
For rapid user interactions (like star ratings), debounce mutations:

```tsx
const timeoutRef = useRef<NodeJS.Timeout | null>(null);

const handleRatingChange = useCallback((id: number, rating: number) => {
  // Apply optimistic update immediately
  applyOptimisticUpdate(id, { rating });
  
  // Clear previous timeout for this item
  if (timeoutRef.current) {
    clearTimeout(timeoutRef.current);
  }
  
  // Debounce the actual mutation
  timeoutRef.current = setTimeout(() => {
    mutation.mutate({ id, rating });
  }, 300);
}, [applyOptimisticUpdate, mutation]);
```

### Inline Editable Fields
Use components from `@/components/trade-detail/editable-field`:
- `EditableField` - for text/number inputs
- `EditableTextarea` - for multiline text
- `EditableSelect` - for dropdowns

```tsx
<EditableField
  label="Entry Price"
  value={trade.entryPrice}
  onChange={(v) => updateField("entryPrice", v)}
  type="number"
  align="right"
/>
```

### API Router Patterns
Use zod schemas and handle nullish values properly:

```tsx
// Allow both null and undefined for optional fields
trailedStopLoss: z.string().nullish(),

// Use .optional() only for truly optional fields
notes: z.string().optional(),
```

### Component Structure
- Use `"use client"` directive for interactive components
- Place page-specific components in `_components/` folder
- Place shared components in `src/components/`
- Use barrel exports (`index.ts`) for component folders

### Styling Conventions
- Use Tailwind CSS classes
- Use `cn()` utility from `@/lib/utils` for conditional classes
- Follow biome formatting (auto-sorted Tailwind classes)
- Use CSS variables from `globals.css` for theme colors

### Error Handling
- Use `toast.error()` from sonner for user-facing errors
- Log errors to console for debugging
- Provide meaningful error messages

### Tags System
When creating tags quickly, assign random colors:
```tsx
const PRESET_COLORS = [
  "#d4ff00", "#00d4ff", "#00ff88", "#f59e0b", 
  "#ec4899", "#8b5cf6", "#14b8a6", "#f97316", "#6366f1"
];

function getRandomColor() {
  return PRESET_COLORS[Math.floor(Math.random() * PRESET_COLORS.length)];
}
```

## File Structure
```
src/
├── app/
│   ├── (marketing)/     # Public pages
│   ├── (protected)/     # Auth-required pages
│   ├── api/             # API routes
│   └── layout.tsx
├── components/
│   ├── ui/              # shadcn components
│   ├── tags/            # Tag management
│   └── trade-detail/    # Trade detail components
├── hooks/               # Custom React hooks
├── lib/                 # Utilities
├── server/
│   ├── api/routers/     # tRPC routers
│   └── db/              # Drizzle schema
└── trpc/                # tRPC client setup
```

## Testing
- Integration tests in `tests/integration/`
- Use vitest for testing
- Test utilities in `tests/utils/`

